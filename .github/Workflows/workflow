on: [push]

jobs:
  tts-job:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        pip install speechbrain torchaudio

    - name: Run TTS example
      run: |
        import torchaudio
        from speechbrain.inference.TTS import Tacotron2
        from speechbrain.inference.vocoders import HIFIGAN

        # Initialize TTS (tacotron2) and Vocoder (HiFIGAN)
        tacotron2 = Tacotron2.from_hparams(source="speechbrain/tts-tacotron2-ljspeech", savedir="tmpdir_tts")
        hifi_gan = HIFIGAN.from_hparams(source="speechbrain/tts-hifigan-ljspeech", savedir="tmpdir_vocoder")

        # Running the TTS
        mel_output, mel_length, alignment = tacotron2.encode_text("Mary had a little lamb")

        # Running Vocoder (spectrogram-to-waveform)
        waveforms = hifi_gan.decode_batch(mel_output)

        # Save the waveform
        torchaudio.save('example_TTS.wav', waveforms.squeeze(1), 22050)

    - name: Upload TTS output
      uses: actions/upload-artifact@v2
      with:
        name: example_TTS
        path: example_TTS.wav